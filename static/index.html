<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Messenger</title>
  <style>
    body {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      background: #f5f5f5;
      font-family: sans-serif;
    }

    .container {
      width: 400px;
      padding: 20px;
      background: white;
      border: 1px solid #ccc;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }

    #chat {
      border: 1px solid #ccc;
      height: 300px;
      overflow-y: auto;
      padding: 10px;
      margin-bottom: 10px;
    }

    input, button {
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
      box-sizing: border-box;
    }

    #controls, #chatControls {
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Вход</h2>
    <input id="email" type="email" placeholder="Email">
    <input id="password" type="password" placeholder="Пароль">
    <button id="loginBtn">Войти</button>

    <div id="controls">
      <h2>Выбери chat_id:</h2>
      <input id="chatIdInput" type="text" placeholder="Введите chat_id">
      <button id="connectBtn">Подключиться</button>

      <div id="chatControls">
        <div id="chat"></div>
        <input id="message" type="text" placeholder="Сообщение">
        <button id="sendBtn">Отправить</button>
      </div>
    </div>
  </div>

  <script>
    let socket;

    document.getElementById("loginBtn").onclick = async () => {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;

      const formData = new URLSearchParams();
      formData.append("username", email);
      formData.append("password", password);

      const response = await fetch("http://localhost:8000/login", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: formData
      });

      if (!response.ok) {
        alert("Ошибка входа");
        return;
      }

      const data = await response.json();
      localStorage.setItem("access_token", data.access_token);
      document.getElementById("controls").style.display = "block";
      alert("Вход успешен! Теперь выбери chat_id.");
    };

    document.getElementById('connectBtn').onclick = () => {
      const chatId = document.getElementById('chatIdInput').value.trim();
      const token = localStorage.getItem("access_token");
      if (!chatId || !token) return;

      socket = new WebSocket(`ws://localhost:8000/ws/chat/${chatId}?token=${token}`);

      socket.onopen = () => {
        document.getElementById('chatControls').style.display = 'block';
        console.log('Connected to chat:', chatId);
      };

      socket.onmessage = (event) => {
        const chat = document.getElementById('chat');
        let messages = JSON.parse(event.data);
        if (Array.isArray(messages)) {
          messages.forEach(msg => {
            const newMsg = document.createElement('div');
            newMsg.textContent = `[${msg.sender_name}]: ${msg.text}`;
            chat.appendChild(newMsg);
          });
        } else {
          const newMsg = document.createElement('div');
          newMsg.textContent = `[${messages.sender_name}]: ${messages.text}`;
          chat.appendChild(newMsg);
        }
      };

      document.getElementById('sendBtn').onclick = () => {
        const input = document.getElementById('message');
        if (input.value.trim() !== '') {
          socket.send(JSON.stringify({
            text: input.value,
            client_id: Math.random().toString(36).substring(2, 10)
          }));
          input.value = '';
        }
      };
    };
  </script>
</body>
</html>
